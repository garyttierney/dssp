(boolean sec_load_policy true)

(sid security)

(block sec
	(typeattribute bool_obj_type_attribute)
	(typeattribute unconfined_subj_type_attribute)

	(call sys.sys_obj_type (bool_obj_type_attribute))

	(typeattribute load_policy_subj_type_attribute)
	(typeattribute
		not_load_policy_subj_type_or_unconfined_subj_type_attribute)

	(typeattributeset
		not_load_policy_subj_type_or_unconfined_subj_type_attribute
		(not (load_policy_subj_type_attribute
			unconfined_subj_type_attribute)))

	(neverallow not_load_policy_subj_type_or_unconfined_subj_type_attribute
		securityfs.fs (security (load_policy)))

	(typeattribute setenforce_subj_type_attribute)
	(typeattribute
		not_setenforce_subj_type_or_unconfined_subj_type_attribute)

	(typeattributeset
		not_setenforce_subj_type_or_unconfined_subj_type_attribute
		(not (setenforce_subj_type_attribute
			unconfined_subj_type_attribute)))

	(neverallow not_setenforce_subj_type_or_unconfined_subj_type_attribute
		securityfs.fs (security (setenforce)))

	(typeattribute setsecparam_subj_type_attribute)
	(typeattribute
		not_setsecparam_subj_type_or_unconfined_subj_type_attribute)

	(typeattributeset
		not_setsecparam_subj_type_or_unconfined_subj_type_attribute
		(not (setsecparam_subj_type_attribute
			unconfined_subj_type_attribute)))

	(neverallow not_setsecparam_subj_type_or_unconfined_subj_type_attribute
		securityfs.fs (security (setsecparam)))

	(allow unconfined_subj_type_attribute securityfs.fs list_dir_perms)
	(allow unconfined_subj_type_attribute securityfs.fs
		read_lnk_file_perms)

	(typeattribute bool_obj_type_except_sec_load_policy_obj_type_attribute)

	(typeattributeset
		bool_obj_type_except_sec_load_policy_obj_type_attribute
		(and (bool_obj_type_attribute) (not (sec_load_policy.bool))))

	(allow unconfined_subj_type_attribute bool_obj_type_attribute
		read_file_perms)
	(allow unconfined_subj_type_attribute
		bool_obj_type_except_sec_load_policy_obj_type_attribute (file
			(append write)))

	(allow unconfined_subj_type_attribute securityfs.fs
		all_security_perms_except_load_policy_and_setenforce)

	(typeattribute
		setsecparam_subj_type_setenforce_subj_type_and_load_policy_subj_type_attribute)

	(typeattributeset
		setsecparam_subj_type_setenforce_subj_type_and_load_policy_subj_type_attribute
		(setsecparam_subj_type_attribute setenforce_subj_type_attribute
			load_policy_subj_type_attribute))

	(call fs.search_sysfs
		(setsecparam_subj_type_setenforce_subj_type_and_load_policy_subj_type_attribute))

	(call rw_files_pattern
		(setsecparam_subj_type_setenforce_subj_type_and_load_policy_subj_type_attribute
			securityfs.fs securityfs.fs))

	(allow setsecparam_subj_type_attribute securityfs.fs (security
		(setsecparam)))
	(auditallow setsecparam_subj_type_attribute securityfs.fs (security
		(setsecparam)))

	(typeattribute
		load_policy_subj_type_and_unconfined_subj_type_attribute)

	(typeattributeset
		load_policy_subj_type_and_unconfined_subj_type_attribute
		(load_policy_subj_type_attribute
			unconfined_subj_type_attribute))

	(typeattribute setenforce_subj_type_and_unconfined_subj_type_attribute)

	(typeattributeset
		setenforce_subj_type_and_unconfined_subj_type_attribute
		(setenforce_subj_type_attribute
			unconfined_subj_type_attribute)))

(block securityfs
	(blockinherit fs.obj_blk)

	(call sec.bool_obj_type (fs)))

(block sec_load_policy
	(blockinherit sec.bool_obj_blk)

	(booleanif sec_load_policy
		(true
			(allow
				sec.setenforce_subj_type_and_unconfined_subj_type_attribute
					securityfs.fs (security (setenforce)))
			(allow
				sec.load_policy_subj_type_and_unconfined_subj_type_attribute
					securityfs.fs (security (load_policy)))
			(allow sec.unconfined_subj_type_attribute bool (file
				(append write))))))
